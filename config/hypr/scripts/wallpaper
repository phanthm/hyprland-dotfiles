#!/bin/bash

FOLDER="/home/phanthm/Pictures/Wallpapers"
HYPRPAPER_CONFIG="/home/phanthm/.config/hypr/hyprpaper.conf"

CHOICE=$(nsxiv -otb "$FOLDER")

if [ -z "$CHOICE" ]; then
    echo "No wallpaper selected. Exiting."
    exit 0
else
    echo "Wallpaper Selected: $CHOICE"
fi

# Get the OLD wallpaper path from the config *before* we overwrite it
OLD_WALLPAPER=$(grep '^preload[[:space:]]*=' "$HYPRPAPER_CONFIG" | awk -F'=' '{print $2}' | xargs)

if ! pgrep -x "hyprpaper" > /dev/null; then
    echo "hyprpaper not running, starting it..."
    hyprpaper &
    sleep 0.5
fi

# load the new wallpaper
hyprctl hyprpaper preload "$CHOICE"
hyprctl hyprpaper wallpaper "eDP-1,$CHOICE"

# Unload the OLD wallpaper from memory
# We only do this if the OLD_WALLPAPER path exists and is different from the new one.
if [ -n "$OLD_WALLPAPER" ] && [ "$OLD_WALLPAPER" != "$CHOICE" ]; then
    echo "Unloading old wallpaper: $OLD_WALLPAPER"
    hyprctl hyprpaper unload "$OLD_WALLPAPER"
fi

wal -i "$CHOICE"

# reload your X server's resources for nsxiv
xrdb -merge ~/.Xresources

# 7. Reload waybar
if pgrep -x "waybar" > /dev/null; then
    pkill -SIGUSR2 waybar
else
    waybar &
fi

# update the config file for the next session
ESCAPED_CHOICE=$(printf '%s\n' "$CHOICE" | sed -e 's:[][\\/.^$*#&]:\\&:g')
sed -i "s#^preload[[:space:]]*=.*#preload=$ESCAPED_CHOICE#" "$HYPRPAPER_CONFIG"
sed -i "s#^wallpaper[[:space:]]*=.*#wallpaper=eDP-1,$ESCAPED_CHOICE#" "$HYPRPAPER_CONFIG"
